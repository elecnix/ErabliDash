<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>ErabliDash (numeric)</title>
  <script language="javascript" type="text/javascript">
    function wsUri(path) {
      var l = window.location;
      return ((l.protocol === "https:") ? "wss://" : "ws://") + l.hostname + (((l.port != 80) && (l.port != 443)) ? ":" + l.port : "") + l.pathname + path;
    }
    var jsonElement;
    var websocket;

    var tankDefs = [{
      // Note: Capacity in Liters
      code: "RS1",
      capacity: 1,
    }, {
      code: "RS2",
      capacity: 1
    }, {
      code: "RSP1",
      capacity: 1
    }, {
      code: "RSP2",
      capacity: 1
    }, {
      code: "RF1",
      capacity: 1
    }, {
      code: "RF2",
      capacity: 1
    }, {
      code: "RC1",
      capacity: 1
    }, {
      code: "RC2",
      capacity: 1
    }];

    var devices = [];
    var valves = [];
    var pumps = [];
    var vacuums = [];

    function liters2gallons(liters) {
      return Math.ceil(liters / 4.54609188);
    }

    function onLoad() {
      createTankLabels();
      openSocket();
      setTimeout(displayDevices, 10000);
    }

    function createTankLabels() {
      tankDefs.forEach(function(tank) {
        var tankElement = document.createElement("tr");

        // Add tank name
        var nameElement = document.createElement("td");
        nameElement.setAttribute('class', 'tankname');
        nameElement.innerHTML = tank.code;
        tankElement.appendChild(nameElement);

        // Add measured contents (gallons)
        var contentsElement = document.createElement('td');
        contentsElement.setAttribute('id', 'tank_' + tank.code + '_contents');
        contentsElement.setAttribute('class', 'tankcontents');
        tankElement.appendChild(contentsElement);

        // Add measured contents (percent)
        var percentElement = document.createElement('td');
        percentElement.setAttribute('id', 'tank_' + tank.code + '_percent');
        percentElement.setAttribute('class', 'tankpercent');
        tankElement.appendChild(percentElement);

        // Add raw value (millimeters)
        var rawValueElement = document.createElement('td');
        rawValueElement.setAttribute('id', 'tank_' + tank.code + '_rawvalue');
        rawValueElement.setAttribute('class', 'rawvalue');
        tankElement.appendChild(rawValueElement);

        // Add capacity (gallons)
        var capacityElement = document.createElement('td');
        capacityElement.setAttribute('id', 'tank_' + tank.code + '_capacity');
        capacityElement.setAttribute('class', 'tankcapacity');
        tankElement.appendChild(capacityElement);

        document.getElementById('tanklist').appendChild(tankElement);
      });
    }

    function populateTankLabels() {
      tankDefs.forEach(function(tank) {
        document.getElementById('tank_' + tank.code + '_contents').innerHTML = liters2gallons(tank.contents);
        document.getElementById('tank_' + tank.code + '_percent').innerHTML = (tank.contents / tank.capacity * 100).toFixed(0) + ' %';
        document.getElementById('tank_' + tank.code + '_rawvalue').innerHTML = tank.rawValue;
        document.getElementById('tank_' + tank.code + '_capacity').innerHTML = liters2gallons(tank.capacity);
      });
    }

    function displayDevices() {
      devices.forEach(function(device) {
        var lastUpdatedAtElemId = 'device_' + device.name + '_lastUpdatedAt';
        var generationElemId = 'device_' + device.name + '_generationId';
        var serialElemId = 'device_' + device.name + '_serial';
        var lastUpdatedAtElem;
        var deviceElemId = 'device_' + device.name;
        if (document.getElementById(deviceElemId) == null) {
          var deviceElem = document.createElement("tr");
          deviceElem.setAttribute('id', deviceElemId);
          document.getElementById('devicelist').appendChild(deviceElem);

          var nameElement = document.createElement("td");
          nameElement.innerHTML = device.name;
          deviceElem.appendChild(nameElement);

          lastUpdatedAtElem = document.createElement('td');
          lastUpdatedAtElem.setAttribute('id', lastUpdatedAtElemId);
          deviceElem.appendChild(lastUpdatedAtElem);

          generationElem = document.createElement('td');
          generationElem.setAttribute('id', generationElemId);
          deviceElem.appendChild(generationElem);

          serialElem = document.createElement('td');
          serialElem.setAttribute('id', serialElemId);
          deviceElem.appendChild(serialElem);
        } else {
          lastUpdatedAtElem = document.getElementById(lastUpdatedAtElemId);
          generationElem = document.getElementById(generationElemId);
          serialElem = document.getElementById(serialElemId);
        }
        var ageInMinutes = Math.floor(Math.abs((Date.now() - new Date(device.lastUpdatedAt).getTime()) / 1000 / 60));
        var ageDisplay = '';
        if (ageInMinutes == 0) {
          ageDisplay = 'now';
        } else if (ageInMinutes == 1) {
          ageDisplay = 'one minute ago';
        } else if (ageInMinutes > 1) {
          ageDisplay = ageInMinutes + ' minutes ago';
        }
        lastUpdatedAtElem.innerHTML = ageDisplay;
        generationElem.innerHTML = device.generationId;
        serialElem.innerHTML = device.lastEventSerial;
      });
    }

    function displayValves() {
      valves.forEach(function(valve) {
        var positionElem;
        var positionElemId = 'valve_' + valve.code + '_position';
        var valveElemId = 'valve_' + valve.code;
        if (document.getElementById(valveElemId) == null) {
          var valveElem = document.createElement("tr");
          valveElem.setAttribute('id', valveElemId);
          document.getElementById('valvelist').appendChild(valveElem);

          var codeElement = document.createElement("td");
          codeElement.innerHTML = valve.code;
          valveElem.appendChild(codeElement);

          positionElem = document.createElement('td');
          positionElem.setAttribute('id', positionElemId);
          valveElem.appendChild(positionElem);
        } else {
          positionElem = document.getElementById(positionElemId);
        }
        positionElem.innerHTML = valve.position;
      });
    }

    function displayPumps() {
      pumps.forEach(function(pump) {
        var stateElem;
        var stateElemId = 'pump_' + pump.code + '_state';
        var dutyElem;
        var dutyElemId = 'pump_' + pump.code + '_duty';
        var pumpElemId = 'pump_' + pump.code;
        if (document.getElementById(pumpElemId) == null) {
          var pumpElem = document.createElement("tr");
          pumpElem.setAttribute('id', pumpElemId);
          document.getElementById('pumplist').appendChild(pumpElem);

          var codeElement = document.createElement("td");
          codeElement.innerHTML = pump.code;
          pumpElem.appendChild(codeElement);

          stateElem = document.createElement('td');
          stateElem.setAttribute('id', stateElemId);
          pumpElem.appendChild(stateElem);

          dutyElem = document.createElement('td');
          dutyElem.setAttribute('id', dutyElemId);
          dutyElem.setAttribute('class', 'pumpduty');
          pumpElem.appendChild(dutyElem);
        } else {
          stateElem = document.getElementById(stateElemId);
          dutyElem = document.getElementById(dutyElemId);
        }
        stateElem.innerHTML = pump.state ? 'ON' : 'OFF';
        dutyElem.innerHTML = (pump.duty * 100).toFixed(0) + ' %';
      });
    }

    function displayVacuum() {
      vacuums.forEach(function(vacuum) {
        var valueElem;
        var valueElemId = 'vacuum_' + vacuum.code + '_value';
        var vacuumElemId = 'vacuum_' + vacuum.code;
        if (document.getElementById(vacuumElemId) == null) {
          var vacuumElem = document.createElement("tr");
          vacuumElem.setAttribute('id', vacuumElemId);
          document.getElementById('vacuumlist').appendChild(vacuumElem);

          var codeElement = document.createElement("td");
          codeElement.innerHTML = vacuum.code;
          vacuumElem.appendChild(codeElement);

          valueElem = document.createElement('td');
          valueElem.setAttribute('id', valueElemId);
          vacuumElem.appendChild(valueElem);
        } else {
          valueElem = document.getElementById(valueElemId);
        }
        valueElem.innerHTML = vacuum.rawValue / 100;
      });
    }

    function openSocket() {
      websocket = new WebSocket(wsUri(""), "dashboard-stream");
      websocket.onopen = function(evt) {
        console.log('Socket opened.');
      };
      websocket.onclose = function(evt) {
        console.log('Socket closed.');
        setTimeout(function() {
          openSocket();
        }, 5000);
      };
      websocket.onmessage = function(msg) {
        var data = JSON.parse(msg.data);
        tankDefs.forEach(function(tankDef, index) {
          var tank = data.tanks.filter(function(tankData) {
            return tankData.code == tankDef.code;
          }).shift();
          tankDef.rawValue = tank.rawValue;
          tankDef.contents = (tank.fill == null ? 0 : tank.fill);
          tankDef.capacity = tank.capacity;
          console.log("Tank %s at %d: %s, raw= %s", tankDef.code, index, tankDef.contents, tankDef.rawValue);
          populateTankLabels();

          devices = data.devices;
          valves = data.valves;
          vacuums = data.vacuum;
          pumps = data.pumps;
          displayDevices();
          displayValves();
          displayPumps();
          displayVacuum();
        });
      };
      websocket.onerror = function(evt) {
        console.console.error('Error:' + evt);
      };
    }
    window.addEventListener("load", onLoad, false);
  </script>
  <style>
    table {
      border-collapse: collapse;
    }

    table,
    th,
    td {
      border: 1px solid #DDD;
      padding: 0.2em;
    }

    .tankcontents,
    .tankpercent,
    .rawvalue,
    .tankcapacity,
    .pumpduty {
      text-align: right;
    }

    #tanks,
    #valves {
      float: left;
      padding-right: 2em;
    }
  </style>
</head>

<body>
  <h1>ErabliDash (numeric)</h1>
  <div>See <a href="/data.json">data.json</a> for the raw data.</div>
  <div id="valves">
    <h3>Valves</h3>
    <table id="valvelist">
      <tr>
        <th>Name</th>
        <th>Position</th>
      </tr>
    </table>
  </div>
  <div id="tanks">
    <h3>Tanks</h3>
    <table id="tanklist">
      <tr>
        <th>Code</th>
        <th>Contents
          <br/>(gal)</th>
        <th>Contents
          <br/>(%)</th>
        <th>Reading
          <br/>(mm)</th>
        <th>Capacity
          <br/>(gal)</th>
      </tr>
    </table>
  </div>
  <div id="devices">
    <h3>Devices</h3>
    <table id="devicelist">
      <tr>
        <th>Name</th>
        <th>Last updated</th>
        <th>Generation</th>
        <th>Serial</th>
      </tr>
    </table>
  </div>
  <div id="pumps">
    <h3>Pompes</h3>
    <table id="pumplist">
      <tr>
        <th>Name</th>
        <th>State</th>
        <th>Duty</th>
      </tr>
    </table>
  </div>
  <div id="vacuums">
    <h3>Vacuum</h3>
    <table id="vacuumlist">
      <tr>
        <th>Name</th>
        <th>Vacuum (po. Hg)</th>
      </tr>
    </table>
  </div>
  <div id="temperatures">
    <h3>Températures</h3>
    <table id="temperaturelist">
      <tr>
        <th>Name</th>
        <th>Enclosure
          <br/>(C)</th>
        <th>US100
          <br/>(C)</th>
        <th>Ambient
          <br/>(C)</th>
      </tr>
    </table>
  </div>
</body>

</html>
